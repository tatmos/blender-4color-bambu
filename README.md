# Blender 4色減色 → 3MF エクスポート（Bambu Studio 向け）

Blender 5.0.1 でメッシュを **4色に減色** し、**色ごとにオブジェクト分割** してから **3MF** でエクスポートするスクリプトです。Bambu Studio 2.5.0.66 などの多色印刷ワークフロー向けです。

## 前提

- **Blender 5.0.1**
- **3MF アドオン**: 3MF のエクスポートには Blender の「3MF format」アドオンが必要です。
  - 編集 → プリファレンス → アドオン → 「3MF」で検索して有効化
  - アドオンが `export_mesh.threemf` または `export_mesh.three_mf` を登録している必要があります

## 色分けがうまくいかないとき

- **診断スクリプト**: 対象メッシュを選択した状態で `diagnose_vertex_colors.py` を実行すると、頂点色レイヤー名（byte/float）とマテリアルが一覧されます。どの色データが使われるか確認できます。
- **頂点色が float の場合**: Blender 4.0+ や OBJ 取り込みで「float カラー属性」になっている場合にも、本スクリプトは byte に続き float を参照するため、多くの場合はそのまま色分けできます。

## 2体・サイズが2種類出てしまう場合

- シーンに**メッシュが2つ以上**あると、それぞれから4個ずつ分割され、**元オブジェクトのスケール差**で「大きい4個＋小さい4個」のように2種のサイズで出力されます。
- **1体だけ出力する**: スクリプトの `USE_SELECTION_ONLY = True`（デフォルト）のときは**選択されたメッシュだけ**処理します。**出力したいメッシュ1つだけを選択**してからスクリプトを実行してください。
- 元オブジェクトが 3MF に含まれないよう、エクスポート時に**元オブジェクトを一時的にコレクションから外して**から出力しています。

## 色が1色と認識される場合（Bambu Studio）

- 3MF アドオンがマテリアル／色をどう書き出すかにより、Bambu Studio で「1色」と表示されることがあります。
- **Bambu Studio 側で**: オブジェクト一覧の各パーツを選択し、右クリックやフィラメントブロックから**オブジェクトごとにフィラメント（色）を割り当て**てください。分割された4オブジェクトにそれぞれ別フィラメントを割り当てると多色になります。
- スクリプト実行後、Blender の「システムコンソール」に `[調査]` ログが出ます。**処理対象メッシュ数**と**作成した分割オブジェクト数・名前・RGB** を確認できます。

## 使い方

1. Blender で減色したいメッシュオブジェクトを用意する。
   - **頂点カラー** がある場合はそれを元に減色します。
   - 頂点カラーがない場合は **マテリアルの Base Color** を元に減色します。
2. **1体だけ出力する場合は、そのメッシュ1つだけを選択する。** 複数選択するとすべて処理されます（`USE_SELECTION_ONLY = False` のときは未選択でも全メッシュが対象）。
3. スクリプトを実行する。
   - スクリプト → ファイルを開く → `export_4color_3mf.py` を選んで「スクリプトを実行」
   - またはテキストエディタに貼り付けて実行
4. 出力先はスクリプト先頭の `OUTPUT_PATH` で変更できます（デフォルト: `D:/3DCG/output_4colors_quantized_only.3mf`）。

## 処理の流れ

1. 選択メッシュから面ごとの色を取得（頂点色 or マテリアル）
2. K-means で 4 色に減色
3. 減色後の色ごとにメッシュを分割し、オブジェクトを新規作成
4. 分割されたオブジェクトだけを選択した状態で 3MF エクスポート

## 設定（スクリプト先頭）

| 変数 | 説明 |
|------|------|
| `OUTPUT_PATH` | 出力 3MF ファイルのパス |
| `NUM_COLORS` | 減色する色数（デフォルト: 4） |
| `KMEANS_ITERATIONS` | 減色の K-means 反復回数 |
| `EXPORT_SCALE` | 出力スケール（0.1 = 10%） |
| `USE_SELECTION_ONLY` | True なら選択メッシュのみ処理（1体だけ出力する場合は1つだけ選択） |

## ライセンス

GPL-3.0-or-later
