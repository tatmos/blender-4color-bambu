# Blender 4色減色 → 頂点色付き OBJ エクスポート（Bambu Studio 向け）

Blender 5.0.1 でメッシュを **4色に減色** し、**頂点色付き OBJ** でエクスポートするスクリプトです。Bambu Studio 2.5.0.66 などの多色印刷ワークフロー向けです。

- **OBJ（頂点色付き）**: 1メッシュのまま頂点色で出力。Bambu Studio で色が認識される場合があります。

## 前提

- **Blender 5.0.1**
- **OBJ**: 標準の OBJ エクスポート（頂点色オプション付き）を使用するためアドオン不要です

## 色分けがうまくいかないとき

- **診断スクリプト**: 対象メッシュを選択した状態で `diagnose_vertex_colors.py` を実行すると、頂点色レイヤー名（byte/float）とマテリアルが一覧されます。どの色データが使われるか確認できます。
- **頂点色が float の場合**: Blender 4.0+ や OBJ 取り込みで「float カラー属性」になっている場合にも、本スクリプトは byte に続き float を参照するため、多くの場合はそのまま色分けできます。
- **色がずれる場合（Rodin 等）**: Rodin の画像は**上下反転が必要な場合があります**。エクスポートダイアログの「テクスチャ補正」で「上下反転」を有効にしてみてください。左右反転や回転補正も試せます。

## 2体・サイズが2種類出てしまう場合

- シーンに**メッシュが2つ以上**あると、それぞれから4個ずつ分割され、**元オブジェクトのスケール差**で「大きい4個＋小さい4個」のように2種のサイズで出力されます。
- **1体だけ出力する**: スクリプトの `USE_SELECTION_ONLY = True`（デフォルト）のときは**選択されたメッシュだけ**処理します。**出力したいメッシュ1つだけを選択**してからスクリプトを実行してください。
- 元オブジェクトがエクスポートに含まれないよう、エクスポート時に**元オブジェクトを一時的にコレクションから外して**から出力しています。

## 色が認識されない・1色と表示される場合（Bambu Studio）

- オブジェクト一覧の各パーツを選択し、右クリックやフィラメントブロックから**オブジェクトごとにフィラメント（色）を割り当て**てください。
- スクリプト実行後、Blender の「システムコンソール」に `[調査]` ログが出ます。処理対象メッシュ数や作成オブジェクト数・名前・RGB を確認できます。

## 使い方

1. Blender で減色したいメッシュオブジェクトを用意する。
   - **頂点カラー** がある場合はそれを元に減色します。
   - 頂点カラーがない場合は **マテリアルの Base Color** を元に減色します。
2. **1体だけ出力する場合は、そのメッシュ1つだけを選択する。** 複数選択するとすべて処理されます（`USE_SELECTION_ONLY = False` のときは未選択でも全メッシュが対象）。
3. スクリプトを実行する。
   - スクリプト → ファイルを開く → `export_4color_3mf.py` を選んで「スクリプトを実行」
   - またはテキストエディタに貼り付けて実行
4. **保存先ダイアログ**が開くので、出力ファイル（`.obj`）のパスを指定する。ダイアログの **「色数」** で 0=減色なし（デフォルト）、2以上=指定色数に減色 を指定できます。ダイアログを使わずスクリプトから直接 `process_scene()` を呼ぶ場合は、スクリプト先頭の `OUTPUT_PATH` と `NUM_COLORS` が使われます。
5. 主要な進捗は Blender のヘッダー（情報エリア）に表示されます。**詳細ログ**（面の色取得 X/N など）は Blender のシステムコンソールに出力されます。Windows ではメニュー「Window > Toggle System Console」でコンソールを表示できます。

## 処理の流れ

- **EXPORT_MODE == "vertex_color_only"**（デフォルト）:
  1. 選択メッシュから面ごとの色を取得（頂点色 or マテリアル or テクスチャ）
  2. 色数=0 なら減色なし、2以上なら K-means で指定色数に減色
  3. 色を**同じメッシュの頂点カラーに書き戻すだけ**（分割しない）
  4. その 1 オブジェクトを **頂点色付き OBJ** でエクスポート
- **EXPORT_MODE == "split"**（従来）:
  1. 選択メッシュから面ごとの色を取得
  2. K-means で 4 色に減色
  3. 減色後の色ごとにメッシュを分割し、オブジェクトを新規作成
  4. 分割されたオブジェクトを OBJ でエクスポート

## 設定（スクリプト先頭）

| 変数 | 説明 |
|------|------|
| `OUTPUT_PATH` | スクリプトから直接 `process_scene()` を呼ぶときのデフォルト出力パス。通常は「スクリプトを実行」でダイアログが開くため、毎回そこで指定する。 |
| `NUM_COLORS` | 0=減色なし（デフォルト）, 2以上=減色する色数 |
| `KMEANS_ITERATIONS` | 減色の K-means 反復回数 |
| `EXPORT_SCALE` | 出力スケール（0.1 = 10%） |
| `USE_SELECTION_ONLY` | True なら選択メッシュのみ処理（1体だけ出力する場合は1つだけ選択） |
| `BAKE_TO_VERTEX_COLOR` | True なら表示色（テクスチャ含む）を頂点カラーにベイクしてから減色 |
| `PRIORITIZE_BAKE_OVER_VERTEX_COLOR` | True（デフォルト）なら頂点カラーがあっても焼き込みを優先。False なら頂点カラーがある場合はそれを使用（焼き込みスキップ） |
| `BAKE_TARGET_ATTR_NAME` | ベイク先のカラー属性名（"Col" で既存を上書き / "Color" で新規） |
| `EXPORT_MODE` | `"split"` = 色ごとにメッシュ分割（従来）, `"vertex_color_only"` = 分割せず頂点色のみ（非多様体回避） |
| `PROGRESS_LOG_INTERVAL` | 進捗ログを出す間隔（面数）。5000 = 5000 面ごとにログ出力。0 で無効。大量頂点で応答なしに見えるときの目安用。 |
| `TEXTURE_SAMPLE_ROTATION` | テクスチャサンプリング時の回転補正（度）。0=なし, 90, 180, 270。 |
| `TEXTURE_SAMPLE_FLIP_H` | テクスチャサンプリングの左右反転。色がずれる場合に試す。 |
| `TEXTURE_SAMPLE_FLIP_V` | テクスチャサンプリングの上下反転。**Rodin の画像は上下反転が必要な場合があります。** |

## エクスポートモード（EXPORT_MODE）と非多様体エッジ回避

- **`"split"`（従来）**: 色ごとにメッシュを分割して出力。境界で**非多様体エッジ**が出ることがある。
- **`"vertex_color_only"`（推奨）**: メッシュは**分割せず1つのまま**、減色した色を**頂点カラーに書き戻すだけ**で出力。ジオメトリは変わらないので非多様体エッジは発生しない。
- ステップで確認する手順:
  1. `EXPORT_MODE = "vertex_color_only"` のままスクリプトを実行する。
  2. Bambu Studio で開き、**非多様体エラーが出ないか**確認する。
  3. **色**: オブジェクトごとにフィラメント（色）を割り当てる。
  4. 従来どおり分割出力にしたい場合は `EXPORT_MODE = "split"` にする。

## 頂点色付き OBJ

- 減色した 4 色が頂点色として書き込まれた OBJ（＋ MTL 等）が出力されます。
- Bambu Studio で OBJ を開いたときに色が付いて表示されれば、多色印刷の色分けとして利用できます。
- 出力パスは `OUTPUT_PATH` で指定し、拡張子が `.obj` でなければ自動で `.obj` に置き換えたパスに保存されます。
- **Bambu Studio で「32色」と出る場合**: パレットを 8bit 離散値に丸める処理（`snap_palette_to_discrete`）により、OBJ 内の色が厳密に N 種類だけになるようになっています。それでも多く認識される場合は、インポート時の「色数指定」を 4（または `NUM_COLORS` の値）に下げて試してください。

## 表示色を頂点カラーにベイクしてから減色（BAKE_TO_VERTEX_COLOR）

- `BAKE_TO_VERTEX_COLOR = True`（デフォルト）のとき、スクリプト実行時に **マテリアルの表示色（テクスチャ・画像含む）を頂点カラーにベイク** してから 4 色減色し、OBJ で出力します。
- Blender 上で見えている色（テクスチャやノードの色）がそのまま減色の元になるため、手動でベイクする必要はありません。
- ベイクには **Cycles** を使用します。レンダーエンジンが一時的に Cycles に切り替わります。
- ベイクを無効にしたい場合は `BAKE_TO_VERTEX_COLOR = False` にしてください。
- **頂点カラーがあっても焼き込みを優先**（`PRIORITIZE_BAKE_OVER_VERTEX_COLOR = True`、デフォルト）: 頂点カラーが既にある場合でも、マテリアル表示色を焼き込んでから減色します。False にすると、頂点カラーがある場合はそれをそのまま使用し、焼き込みをスキップします。
- **テクスチャサンプリングフォールバック**: ベイク結果が単色の場合、自動的にマテリアルの Image Texture を UV で直接サンプリングして再試行します。Cycles ベイクがうまくいかない環境でも、UV とテクスチャが正しく設定されていれば色分けできます。
- **Rodin などのモデル**: 色がずれる場合、ダイアログの「上下反転」を有効にしてください。Rodin の画像は上下反転が必要な場合があります。

## PNG テクスチャの減色ツール（`reduce_color_png.py`）

Blender とは独立した CLI ツールです。**PNG 画像**を指定色数に減色し、中間色は **Floyd–Steinberg ディザ**で表現します（多色印刷で限られた色数を擬似的に広げる用途向け）。

- **必要**: Python 3 + Pillow（`pip install Pillow`）
- **使い方**:
  ```bash
  python reduce_color_png.py input.png -n 4 -o output.png
  ```
- **主なオプション**:
  - `-n`, `--colors N` … 減色後の色数（デフォルト: 4）
  - `-o`, `--output` … 出力 PNG パス（省略時は `入力名_Ncolor.png`）
  - `--no-dither` … ディザなし（最も近いパレット色にのみ置き換え）
  - `--max-pixels N` … パレット計算に使う最大ピクセル数（巨大画像用、デフォルト: 500000）
  - `--kmeans-iterations N` … K-means の反復回数（デフォルト: 30）

減色は K-means でパレットを算出し、アルファはそのまま維持します。

### Blender 上で動かす（`reduce_color_png_blender.py`）

同じ減色＋ディザ処理を **Blender 内**で実行できます。Pillow は不要で、Blender 標準の画像 API のみ使用します。

- **使い方**  
  1. Blender で **スクリプト**ワークスペース、またはテキストエディタを開く  
  2. **スクリプト → ファイルを開く** で `reduce_color_png_blender.py` を選択 → **スクリプトを実行**  
  3. ファイル選択ダイアログが開くので、減色したい PNG を選ぶ  
  4. オペレーターのプロパティで **色数**・**ディザを使用**・**出力先**などを指定し、実行  

- **メニューから実行**: 実行後、**UV/画像エディタ**の **画像** メニューに「画像を減色（指定色数＋ディザ）」が追加されます。どこからでも **F3** で「減色」と検索して実行できます。  
- **出力**: 出力先を空にすると、入力ファイルと同じフォルダに `入力名_Ncolor.png` で保存されます。

## リメッシュ＋テクスチャ保持（`remesh_preserve_texture.py`）

リメッシュモディファイアはジオメトリを作り直すため、元の UV が失われテクスチャが崩れます。このスクリプトは**リメッシュしつつ、元の見た目をベイクで転写**します。

- **手順**: テクスチャ付きメッシュを選択 → スクリプトを実行
- **処理の流れ**:
  1. 選択オブジェクトを複製
  2. 複製にリメッシュモディファイアを追加・適用（設定はスクリプト先頭の定数で変更可能）
  3. リメッシュ後のメッシュに Smart UV Project で UV を付与
  4. 「選択→アクティブ」ベイクで、**元オブジェクト**の表示（テクスチャ・マテリアル）を**リメッシュ後オブジェクト**の UV に焼き付け
- **結果**: 元オブジェクト名 + `_remeshed` のオブジェクトが追加され、リメッシュ後の形状に元のテクスチャが適用されます。デフォルトでは元オブジェクトは非表示になります。
- **設定（スクリプト先頭）**: `REMESH_MODE`（BLOCKS / SMOOTH / SHARP / VOXEL）、`OCTREE_DEPTH`、`REMESH_SCALE`、`BAKE_IMAGE_SIZE`、`HIDE_ORIGINAL_AFTER_BAKE` など。

## UV画像（JPG/PNG 等）をファイルに保存する

UV やマテリアルで使っているテクスチャ（JPG・PNG など）をディスク上のファイルとして保存する方法です。

### 1. Blender の UI で 1 枚だけ保存する

- **UV/画像エディタ**で、保存したい画像を表示する（ドロップダウンで画像を選ぶ）。
- メニュー **画像** → **画像を保存**（上書き）または **別名で保存**（保存先を指定）。
- これで、その画像が PNG/JPG などでファイルに書き出されます。**パック済み**（.blend 内に取り込んだ画像）でも「別名で保存」でファイル化できます。

### 2. まとめてフォルダに保存する（`save_uv_images_blender.py`）

複数の UV 画像を一括でフォルダに書き出したいとき用のスクリプトです。**パックされた画像**もファイルとして保存できます。

- **使い方**: スクリプトを実行後、**F3** で「UV画像」や「フォルダに保存」と検索 → **UV画像をフォルダに保存** を実行。
- ダイアログで「保存先フォルダ内の任意のファイル」を選ぶ（例: そのフォルダに `dummy.png` と入力して保存先を指定）。実際に使われるのは**フォルダのパス**だけです。
- **選択オブジェクトで使っている画像のみ**: オンなら、選択中のメッシュのマテリアルで参照されている画像だけを保存。オフなら、プロジェクト内の画像データをすべて保存します。
- **保存形式**: 元の形式のまま / PNG に統一 / JPEG に統一 を選べます。

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `export_4color_3mf.py` | 4色減色 → 頂点色付き OBJ エクスポートのメインスクリプト |
| `remesh_preserve_texture.py` | リメッシュしつつ元テクスチャをベイクで転写するスクリプト |
| `reduce_color_png.py` | PNG テクスチャの指定色数減色＋ディザツール（CLI） |
| `reduce_color_png_blender.py` | 上記と同じ減色＋ディザを Blender 上で実行するオペレーター |
| `save_uv_images_blender.py` | UV/マテリアルで使っている画像をフォルダに一括保存するオペレーター |
| `diagnose_vertex_colors.py` | 選択メッシュの頂点色レイヤー・マテリアルを一覧する診断用スクリプト |
| `README.md` | 本ドキュメント |

## ライセンス

GPL-3.0-or-later
